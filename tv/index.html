<!DOCTYPE html>
<html>
<head>
<title>ateaish TV</title>
<script type="text/javascript" src="https://cdn.embed.ly/player-0.1.0.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script type="text/javascript" src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
<style>
  @font-face {
    font-family: 'OumaBold';
    src: url('fonts/OumaTrial-Bold.ttf') format('truetype');
    font-weight: bold;
    font-style: normal;
  }
  @font-face {
    font-family: 'OumaLight';
    src: url('fonts/OumaTrial-Light.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
  }

  html, body {
    font-family: 'OumaLight', sans-serif;
    margin: 0;
    padding: 0;
    width: 100vw;
    height: 100vh;
    min-height: 100vh;
    box-sizing: border-box;
    background-color: #000;
    overflow: hidden;
  }
  *, *:before, *:after {
    box-sizing: inherit;
  }
  #app-wrapper {
    position: relative;
    height: 100vh;
    width: 100vw;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  #controls {
    position: static;
    width: 100%;
    padding: 10px;
    box-sizing: border-box;
    background-color: #000; /* solid black */
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 10px;
    color: white;
    border-bottom: 2px solid #222;
    transition: none;
  }
  #controls.hidden {
    opacity: 1;
    pointer-events: auto;
  }
  #controls select, #controls button {
    border-radius: 4px;
    border: 1px solid #ccc;
    padding: 5px;
  }
  #fullscreen-btn {
    font-family: 'OumaLight', sans-serif;
    margin-left: auto; /* push to right */
    background-color: #000; /* black button */
    color: #fff; /* white text */
    border: 1px solid #444;
    border-radius: 4px;
    padding: 5px 12px;
    cursor: pointer;
  }
  #fullscreen-btn:hover {
    background-color: #222;
  }
  #main-layout {
    display: flex;
    flex: 1;
    height: calc(100vh - 48px);
    width: 100vw;
  }
  #player-section {
    position: relative;
    width: 70%;
    height: 100%;
    display: flex;
    flex-direction: column;
  }
  #player-container {
    position: relative;
    width: 100%;
    height: 100%;
    flex: 1;
    overflow: hidden;
    z-index: 1;
  }
  #player-iframe, #player-video {
    width: 100%;
    height: 100%;
    border: none;
    z-index: 1;
    background: #000;
    display: none;
    position: absolute;
    top: 0;
    left: 0;
  }
  #player-iframe.active, #player-video.active {
    display: block;
  }
  #menu-section {
    width: 30%;
    padding: 10px;
    color: white;
    overflow-y: auto;
  }
  .channel-item {
    padding: 10px;
    border: 1px solid #444;
    margin: 5px 0;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  .channel-item:hover {
    background-color: rgba(255, 255, 255, 0.1);
  }
  .channel-item.active {
    background-color: rgba(255, 255, 255, 0.2);
  }

  h2, #current-channel-name {
    font-family: 'OumaBold', sans-serif;
  }
</style>
</head>
<body>
<div id="app-wrapper">
  <div id="main-layout">
    <div id="player-section">
      <div id="controls">
        <img src="assets/ateaish_tv_blanc_150ppi_noborder.png" alt="ateaish TV" style="height:32px; margin-right:16px;">
        <div id="current-channel-name" style="flex:1; text-align:center; font-weight:bold; font-size:1.2em;"></div>
        <button id="fullscreen-btn">
          Fullscreen
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" style="vertical-align:middle; margin-left:6px;" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
          </svg>
        </button>
        <select id="server-select" style="display:none;"></select>
        <button id="switch-server-btn" style="display: none;">Switch Source</button>
      </div>
      <div id="player-container">
        <iframe id="player-iframe"></iframe>
        <video id="player-video" controls></video>
      </div>
    </div>
    <div id="menu-section">
      <h2 style="color:white; margin:10px;">Channels</h2>
      <div id="channel-list"></div>
    </div>
  </div>
</div>
<script>
  const controls = document.getElementById('controls');
  const playerIframe = document.getElementById('player-iframe');
  const playerVideo = document.getElementById('player-video');
  const witvBaseUrl = 'https://witv.soccer/player/playerjs/witv-player.php?id=';
  const tutvliveBaseUrl = 'https://tutvlive.ru/player/';

  const fullscreenBtn = document.getElementById('fullscreen-btn');
  const switchServerBtn = document.getElementById('switch-server-btn');
  const serverSelect = document.getElementById('server-select');

  let channels = [];
  let player;
  let currentChannelIndex = 0;
  let currentSourceType = '';
  let currentServerIndex = 0;
  let m3u8Timeout = null;
  let m3u8Tried = false;

  fetch('channels.json')
    .then(response => response.json())
    .then(data => {
      channels = data;
      populateChannelList();
      updatePlayer(currentChannelIndex);
      player = new playerjs.Player(playerIframe);
      addPlayerListeners();
    });

  function populateChannelList() {
    const channelList = document.getElementById('channel-list');
    channelList.innerHTML = '';
    channels.forEach((channel, index) => {
      const div = document.createElement('div');
      div.className = 'channel-item'; // No active highlight
      div.textContent = channel.name;
      div.onclick = () => {
        updatePlayer(index);
      };
      channelList.appendChild(div);
    });
  }

  function populateServerSelect(servers) {
    serverSelect.innerHTML = '';
    servers.forEach((server, idx) => {
      const option = document.createElement('option');
      option.value = idx;
      option.textContent = 'Server ' + (idx + 1);
      serverSelect.appendChild(option);
    });
    serverSelect.style.display = servers.length > 1 ? 'inline-block' : 'none';
  }

  function tryNextSource(channelIndex, triedSources) {
    const channel = channels[channelIndex];
    const sources = channel.sources || [];
    // Priority: m3u8, mpd, tutvlive, witv
    let nextSource = null;
    if (!triedSources.includes('m3u8')) {
      nextSource = sources.find(s => s.type === 'm3u8' || (s.url && s.url.endsWith('.m3u8')));
      if (nextSource) return updatePlayer(channelIndex, 'm3u8', 0, triedSources.concat('m3u8'));
    }
    if (!triedSources.includes('mpd')) {
      nextSource = sources.find(s => s.type === 'mpd' || (s.url && s.url.endsWith('.mpd')));
      if (nextSource) return updatePlayer(channelIndex, 'mpd', 0, triedSources.concat('mpd'));
    }
    if (!triedSources.includes('tutvlive')) {
      nextSource = sources.find(s => s.type === 'tutvlive');
      if (nextSource) return updatePlayer(channelIndex, 'tutvlive', 0, triedSources.concat('tutvlive'));
    }
    if (!triedSources.includes('witv')) {
      nextSource = sources.find(s => s.type === 'witv');
      if (nextSource) return updatePlayer(channelIndex, 'witv', 0, triedSources.concat('witv'));
    }
    // No more sources
    alert('No working stream found for this channel.');
  }

  function updatePlayer(channelIndex, sourceType, serverIdx = 0, triedSources = []) {
    currentChannelIndex = channelIndex;
    currentServerIndex = serverIdx;
    switchServerBtn.style.display = 'none'; // Always hide at start
    const channel = channels[currentChannelIndex];
    // Update channel name in controls bar
    document.getElementById('current-channel-name').textContent = channel ? channel.name : '';
    if (!channel || !channel.sources || channel.sources.length === 0) {
      console.error('Invalid channel data:', channel);
      return;
    }
    // Stop and cleanup previous video/iframe
    if (window.hls) {
      window.hls.destroy();
      window.hls = null;
    }
    playerVideo.pause();
    playerVideo.removeAttribute('src');
    playerVideo.load();
    playerVideo.style.display = 'none';
    playerIframe.src = '';
    playerIframe.style.display = 'none';
    serverSelect.style.display = 'none';
    if (m3u8Timeout) {
      clearTimeout(m3u8Timeout);
      m3u8Timeout = null;
    }
    const sources = channel.sources;
    let source = null;
    if (sourceType) {
      if (sourceType === 'm3u8') {
        source = sources.find(s => s.type === 'm3u8' || (s.url && s.url.endsWith('.m3u8')));
      } else if (sourceType === 'mpd') {
        source = sources.find(s => s.type === 'mpd' || (s.url && s.url.endsWith('.mpd')));
      } else if (sourceType === 'tutvlive') {
        source = sources.find(s => s.type === 'tutvlive');
      } else if (sourceType === 'witv') {
        source = sources.find(s => s.type === 'witv');
      }
    } else {
      source = sources.find(s => s.type === 'm3u8' || (s.url && s.url.endsWith('.m3u8')))
        || sources.find(s => s.type === 'mpd' || (s.url && s.url.endsWith('.mpd')))
        || sources.find(s => s.type === 'tutvlive')
        || sources.find(s => s.type === 'witv');
      sourceType = source ? source.type : '';
    }
    if (!source) {
      console.error('No suitable source found for channel:', channel);
      return;
    }
    currentSourceType = sourceType;
    // Show server select for tutvlive
    if (sourceType === 'tutvlive' && source.servers && source.servers.length > 1) {
      populateServerSelect(source.servers);
      serverSelect.value = serverIdx;
      serverSelect.style.display = 'inline-block';
    } else {
      serverSelect.style.display = 'none';
    }
    let url;
    if (sourceType === 'witv') {
      url = witvBaseUrl + source.id + '&q=1080';
      playerIframe.classList.add('active');
      playerIframe.style.display = 'block';
      playerIframe.src = url;
      setTimeout(() => {
        player = new playerjs.Player(playerIframe);
        addPlayerListeners();
        player.play();
        player.unmute();
      }, 500);
    } else if (sourceType === 'tutvlive') {
      const server = source.servers[serverIdx] || source.servers[0];
      url = `${tutvliveBaseUrl}${server}/${source.id}`;
      playerIframe.classList.add('active');
      playerIframe.style.display = 'block';
      playerIframe.src = url;
      setTimeout(() => {
        player = new playerjs.Player(playerIframe);
        addPlayerListeners();
        player.play();
        player.unmute();
      }, 500);
    } else if (sourceType === 'm3u8') {
      url = source.url || source;
      playerVideo.classList.add('active');
      playerVideo.style.display = 'block';
      playerVideo.src = '';
      let played = false;
      if (Hls.isSupported()) {
        if (window.hls) { window.hls.destroy(); }
        window.hls = new Hls();
        window.hls.loadSource(url);
        window.hls.attachMedia(playerVideo);
        window.hls.on(Hls.Events.MANIFEST_PARSED, function() {
          playerVideo.play();
        });
        window.hls.on(Hls.Events.ERROR, function(event, data) {
          if (data.fatal && !m3u8Tried) {
            m3u8Tried = true;
            tryNextSource(channelIndex, triedSources.concat('m3u8'));
          }
        });
      } else if (playerVideo.canPlayType('application/vnd.apple.mpegurl')) {
        playerVideo.src = url;
        playerVideo.addEventListener('loadedmetadata', function() {
          playerVideo.play();
        });
      }
      // Fallback: if not playing after 10s, try next source
      m3u8Timeout = setTimeout(() => {
        if (playerVideo.paused && !m3u8Tried) {
          m3u8Tried = true;
          tryNextSource(channelIndex, triedSources.concat('m3u8'));
        }
      }, 10000);
      // Dummy player object for controls compatibility
      player = {
        play: () => playerVideo.play(),
        pause: () => playerVideo.pause(),
        getPaused: cb => cb(playerVideo.paused),
        mute: () => { playerVideo.muted = true; },
        unmute: () => { playerVideo.muted = false; },
        getMuted: cb => cb(playerVideo.muted)
      };
      addPlayerListeners();
      player.unmute();
    } else if (sourceType === 'mpd') {
      url = source.url || source;
      playerVideo.classList.add('active');
      playerVideo.style.display = 'block';
      playerVideo.src = '';
      if (window.dashjsPlayer) {
        window.dashjsPlayer.reset();
        window.dashjsPlayer = null;
      }
      window.dashjsPlayer = dashjs.MediaPlayer().create();
      window.dashjsPlayer.initialize(playerVideo, url, true);
      // Dummy player object for controls compatibility
      player = {
        play: () => playerVideo.play(),
        pause: () => playerVideo.pause(),
        getPaused: cb => cb(playerVideo.paused),
        mute: () => { playerVideo.muted = true; },
        unmute: () => { playerVideo.muted = false; },
        getMuted: cb => cb(playerVideo.muted)
      };
      addPlayerListeners();
      player.unmute();
    }
    // Show switch source if more than one type
    const hasM3u8 = sources.some(s => s.type === 'm3u8' || (s.url && s.url.endsWith('.m3u8')));
    const hasMpd = sources.some(s => s.type === 'mpd' || (s.url && s.url.endsWith('.mpd')));
    const hasTutvlive = sources.some(s => s.type === 'tutvlive');
    const hasWitv = sources.some(s => s.type === 'witv');
    let count = [hasM3u8, hasMpd, hasTutvlive, hasWitv].filter(Boolean).length;
    switchServerBtn.style.display = count > 1 ? 'inline-block' : 'none';
    populateChannelList();
  }

  serverSelect.addEventListener('change', (event) => {
    if (currentSourceType === 'tutvlive') {
      updatePlayer(currentChannelIndex, 'tutvlive', parseInt(event.target.value));
    }
  });

  switchServerBtn.addEventListener('click', () => {
    // Switch between available source types in priority order
    const channel = channels[currentChannelIndex];
    const sources = channel.sources || [];
    let nextType = '';
    if (currentSourceType === 'm3u8') {
      nextType = sources.find(s => s.type === 'tutvlive') ? 'tutvlive' : (sources.find(s => s.type === 'witv') ? 'witv' : '');
    } else if (currentSourceType === 'tutvlive') {
      nextType = sources.find(s => s.type === 'witv') ? 'witv' : (sources.find(s => s.type === 'm3u8') ? 'm3u8' : '');
    } else if (currentSourceType === 'witv') {
      nextType = sources.find(s => s.type === 'm3u8') ? 'm3u8' : (sources.find(s => s.type === 'tutvlive') ? 'tutvlive' : '');
    }
    if (nextType) {
      m3u8Tried = false;
      updatePlayer(currentChannelIndex, nextType);
    }
  });

  fullscreenBtn.addEventListener('click', () => {
    // Determine which player is visible
    if (playerVideo.classList.contains('active') && playerVideo.style.display === 'block') {
      if (playerVideo.requestFullscreen) playerVideo.requestFullscreen();
      else if (playerVideo.mozRequestFullScreen) playerVideo.mozRequestFullScreen();
      else if (playerVideo.webkitRequestFullscreen) playerVideo.webkitRequestFullscreen();
      else if (playerVideo.msRequestFullscreen) playerVideo.msRequestFullscreen();
    } else if (playerIframe.classList.contains('active') && playerIframe.style.display === 'block') {
      if (playerIframe.requestFullscreen) playerIframe.requestFullscreen();
      else if (playerIframe.mozRequestFullScreen) playerIframe.mozRequestFullScreen();
      else if (playerIframe.webkitRequestFullscreen) playerIframe.webkitRequestFullscreen();
      else if (playerIframe.msRequestFullscreen) playerIframe.msRequestFullscreen();
    }
  });

  let hideTimeout;
  function showControls() {
    controls.classList.remove('hidden');
    clearTimeout(hideTimeout);
    hideTimeout = setTimeout(() => {
      controls.classList.add('hidden');
    }, 5000);
  }
  document.addEventListener('mousemove', showControls);
  showControls();
</script>

</body>
</html>